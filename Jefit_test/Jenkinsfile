pipeline {
    agent any

    stages {

        stage('Restore') {
            steps {
                bat 'dotnet restore "D:/Kurs/Jefit/QAC07-jefit_autotest/Jefit_test/Jefit_test.sln"'
            }
        }

        stage('Build') {
            steps {
                bat 'dotnet build "D:/Kurs/Jefit/QAC07-jefit_autotest/Jefit_test/Jefit_test.sln" --no-restore'
            }
        }

        stage('Test') {
            steps {
                // –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É –¥–ª—è Allure
                bat 'if not exist allure-results mkdir allure-results'

                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –∏ —É–∫–∞–∑—ã–≤–∞–µ–º Allure, –∫—É–¥–∞ –ø–∏—Å–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                bat '''
                dotnet test "D:/Kurs/Jefit/QAC07-jefit_autotest/Jefit_test/Jefit_test.sln" ^
                --logger:"console;verbosity=detailed" ^
                -- TestRunParameters.Parameter(name="allure.results.directory", value="allure-results")
                '''
            }
        }
    }

    post {
        always {
            echo 'üì¶ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Allure-–æ—Ç—á—ë—Ç...'

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞
            bat 'allure generate allure-results --clean -o allure-report'

            // –ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞ –≤ Jenkins
            script {
                allure([
                    includeProperties: false,
                    jdk: '',
                    results: [[path: 'allure-results']],
                    reportBuildPolicy: 'ALWAYS'
                ])
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º .trx-—Ñ–∞–π–ª—ã (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
            archiveArtifacts artifacts: '**/*.trx', allowEmptyArchive: true
        }

        failure {
            echo '‚ùå –¢–µ—Å—Ç—ã —É–ø–∞–ª–∏!'
        }

        success {
            echo '‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!'
        }
    }
}
