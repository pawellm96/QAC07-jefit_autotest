pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/pawellm96/QAC07-jefit_autotest.git'
            }
        }

        stage('Clean Workspace') {
            steps {
                script { deleteDir() }
            }
        }

        stage('Restore dependencies') {
            steps {
                dir('Jefit_test/Jefit_test') {
                    bat 'dotnet restore Jefit_test.sln'
                }
            }
        }

        stage('Build') {
            steps {
                dir('Jefit_test/Jefit_test') {
                    bat 'dotnet build Jefit_test.sln --configuration Release'
                }
            }
        }

        stage('Run Tests') {
            steps {
                dir('Jefit_test/Jefit_test') {
                    echo "Running all tests"
                    // Запуск тестов
                    bat '''
                        dotnet test Jefit_test.sln ^
                        --logger:"trx;LogFileName=test-result.trx" ^
                        || exit 0
                    '''
                    // Создание папки allure-results на уровне workspace
                    bat 'if not exist ..\\..\\allure-results mkdir ..\\..\\allure-results'
                    // Копирование файла результата
                    bat 'copy test-result.trx ..\\..\\allure-results /Y'
                }
            }
        }

        stage('Generate Allure Report') {
            steps {
                bat '"D:/Kurs/Allure/allure-2.35.1/bin/allure.bat" generate allure-results --clean -o allure-report'
            }
        }

        stage('Publish Allure Report') {
            steps {
                script {
                    allure([
                        includeProperties: false,
                        jdk: '',
                        results: [[path: 'allure-results']],
                        reportBuildPolicy: 'ALWAYS'
                    ])
                }
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'allure-results/**', allowEmptyArchive: true
            echo 'Pipeline finished.'
        }

        failure {
            echo 'Test run FAILED!'
        }

        success {
            echo 'Test run SUCCESSFUL!'
        }
    }
}
