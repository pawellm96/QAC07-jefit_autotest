pipeline {
    agent any

    environment {
        DOTNET_CLI_HOME = '.'
        ALLURE_HOME = 'D:/Kurs/Allure/allure-2.35.1/bin'
        ALLURE_RESULTS_DIR = 'allure-results'
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/pawellm96/QAC07-jefit_autotest.git'
            }
        }

        stage('Restore dependencies') {
            steps {
                dir('Jefit_test') {
                    bat 'dotnet restore Jefit_test.sln'
                }
            }
        }

        stage('Build') {
            steps {
                dir('Jefit_test') {
                    bat 'dotnet build Jefit_test.sln --configuration Release'
                }
            }
        }

        stage('Run Tests') {
            steps {
                dir('Jefit_test') {
                    bat 'dotnet test Jefit_test.sln --configuration Release --logger "trx;LogFileName=test_results.trx"'
                }
            }
            post {
                always {
                    allure includeProperties: false, jdk: '', results: [[path: 'allure-results']]
                }
            }
        }

        stage('Generate Allure Report') {
            steps {
                bat "\"${env.ALLURE_HOME}/allure.bat\" generate ${env.ALLURE_RESULTS_DIR} --clean -o allure-report"
            }
        }

        stage('Publish Allure Report') {
            steps {
                allure includeProperties: false, jdk: '', results: [[path: 'allure-results']]
            }
        }
    }

    post {
        always {
            junit 'Jefit_test/TestResults/*.trx'
            cleanWs()
        }
    }
}
